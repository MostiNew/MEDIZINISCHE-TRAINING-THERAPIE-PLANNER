<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTT-Planer FHIR Export</title>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:#f5f7fa;margin:0;padding:12px;color:#1f2937}
h1,h2{margin:0 0 8px}
.container{max-width:1200px;margin:auto}
.card{background:#fff;border-radius:10px;padding:12px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.08)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
input,select,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #cbd5e1;font-size:.8rem}
textarea{resize:vertical}
.actions{display:flex;gap:8px;margin-bottom:12px}
button{padding:10px;border-radius:8px;border:none;background:#0284c7;color:#fff;font-size:.85rem;cursor:pointer}
button.secondary{background:#334155}
table{width:100%;border-collapse:collapse;font-size:.75rem}
th{background:#0284c7;color:#fff;padding:6px}
td{border-bottom:1px solid #e2e8f0;padding:6px;text-align:center}
@media print{body{background:#fff}.actions,.screen-only{display:none}.print-only{display:block}}
.print-only{display:none}
</style>
</head>
<body>
<div class="container">
<h1>MTT-Therapieplan</h1>

<div class="actions screen-only">
<button onclick="window.print()">üñ®Ô∏è Drucken / PDF</button>
<button class="secondary" onclick="exportJSON()">üíæ JSON (FHIR)</button>
<button class="secondary" onclick="exportCSV()">üíæ CSV</button>
<button class="secondary" onclick="savePatient()">üìÇ Speichern</button>
<button class="secondary" onclick="loadPatient()">üìÇ Laden</button>
</div>

<!-- Patient Info -->
<div class="card screen-only">
<h2>Patient & Station</h2>
<div class="grid">
<input id="pid" placeholder="Patienten-ID">
<input id="name" placeholder="Name, Vorname">
<input id="dob" type="date">
<input id="station" placeholder="Station">
<input id="arzt" placeholder="Arzt">
<input id="therapeut" placeholder="Therapeut">
<input id="datum" type="date">
</div>
</div>

<!-- Therapieplanung -->
<div class="card screen-only">
<h2>Therapieplanung</h2>
<div class="grid">
<input id="diagnose" placeholder="Diagnose">
<select id="phase">
<option>Akut</option><option>Aufbau</option><option>Funktionell</option><option>Return-to-Activity</option>
</select>
<textarea id="icf" placeholder="ICF-Ziele"></textarea>
<input id="schmerz" placeholder="Schmerz (NRS)">
</div>
</div>

<!-- √úbungseingabe -->
<div class="card screen-only">
<h2>MTT-√úbungen</h2>
<table id="exerciseInput">
<tr>
<th>‚úî</th><th>Nr</th><th>Art</th><th>Ger√§t</th>
<th>Watt</th><th>kg</th><th>S√§tze</th>
<th>Wdh</th><th>UPM</th><th>Pause</th><th>Kommentar</th>
</tr>
</table>
</div>

<!-- Print Layout -->
<div class="print-only">
<h2>Patient</h2>
<p><b>ID:</b> <span id="p_pid"></span></p>
<p><b>Name:</b> <span id="p_name"></span></p>
<p><b>Geburtsdatum:</b> <span id="p_dob"></span></p>
<p><b>Station:</b> <span id="p_station"></span></p>
<p><b>Arzt:</b> <span id="p_arzt"></span></p>
<p><b>Therapeut:</b> <span id="p_therapeut"></span></p>
<p><b>Datum:</b> <span id="p_datum"></span></p>

<h2>Therapieplanung</h2>
<p><b>Diagnose:</b> <span id="p_diagnose"></span></p>
<p><b>Phase:</b> <span id="p_phase"></span></p>
<p><b>ICF-Ziele:</b> <span id="p_icf"></span></p>
<p><b>Schmerz:</b> <span id="p_schmerz"></span></p>

<h2>MTT-√úbungen</h2>
<table id="exercisePrint">
<tr>
<th>Nr</th><th>Art</th><th>Ger√§t</th>
<th>Watt</th><th>kg</th><th>S√§tze</th>
<th>Wdh</th><th>UPM</th><th>Pause</th><th>Kommentar</th>
</tr>
</table>
</div>
</div>

<script>
const geraete=["Laufband","Fahrradergometer","Arm-Ergometer","Ellipsentrainer","Stepper",
"Ruderergometer","Seilzug","Latzug","Chest Press","Beinpresse","Beinstrecker",
"Beinbeuger","Abduktor","Adduktor","Rumpfbeuger","Rumpfstrecker",
"Schulterpresse","Bizeps","Trizeps","Wadenpresse"];

const table=document.getElementById("exerciseInput");

// Build 70 rows
for(let i=1;i<=70;i++){
  const r=table.insertRow();
  r.innerHTML=`
  <td><input type="checkbox"></td>
  <td>${i}</td>
  <td><select><option></option><option>Kraft</option><option>Ausdauer</option><option>Mobilit√§t</option><option>Stabilisation</option></select></td>
  <td><select><option></option>${geraete.map(g=>`<option>${g}</option>`).join("")}</select></td>
  <td><input></td><td><input></td><td><input></td>
  <td><input></td><td><input></td><td><input></td><td><input></td>
  `;
}

// Populate print table just before printing
window.onbeforeprint = () => {
  const pt = document.getElementById("exercisePrint");

  // Copy patient info
  p_pid.textContent = pid.value;
  p_name.textContent = name.value;
  p_dob.textContent = dob.value;
  p_station.textContent = station.value;
  p_arzt.textContent = arzt.value;
  p_therapeut.textContent = therapeut.value;
  p_datum.textContent = datum.value;

  p_diagnose.textContent = diagnose.value;
  p_phase.textContent = phase.value;
  p_icf.textContent = icf.value;
  p_schmerz.textContent = schmerz.value;

  // Reset print table with header
  pt.innerHTML = `<tr>
<th>Nr</th><th>Art</th><th>Ger√§t</th>
<th>Watt</th><th>kg</th><th>S√§tze</th>
<th>Wdh</th><th>UPM</th><th>Pause</th><th>Kommentar</th>
</tr>`;

  // Add only filled/checked exercises
  [...table.rows].slice(1).forEach(r=>{
    const inputs = r.querySelectorAll("input, select");
    const checked = inputs[0].checked;
    const values = Array.from(inputs).slice(1).map(i=>i.value.trim());
    if(checked || values.some(v=>v!=="")){
      const row = pt.insertRow();
      row.insertCell().textContent = r.cells[1].innerText; // Nr
      values.forEach(v=>row.insertCell().textContent=v||"‚Äî");
    }
  });
};

// Storage
function savePatient(){
  localStorage.setItem("MTT_PAT",JSON.stringify(getData()));
  alert("Gespeichert");
}
function loadPatient(){
  const d=JSON.parse(localStorage.getItem("MTT_PAT"));
  if(!d){alert("Keine Daten");return;}
  Object.keys(d).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value=d[k];
  });
}

// Collect exercises
function getExercises(){
  return [...table.rows].slice(1).map(r=>{
    const inputs=r.querySelectorAll("input, select");
    const checked = inputs[0].checked;
    const values = Array.from(inputs).slice(1).map(i=>i.value.trim());
    if(checked || values.some(v=>v!=="")){
      return {
        nr: r.cells[1].innerText,
        art: values[0]||null,
        geraet: values[1]||null,
        watt: values[2]||null,
        kg: values[3]||null,
        saetze: values[4]||null,
        wdh: values[5]||null,
        upm: values[6]||null,
        pause: values[7]||null,
        kommentar: values[8]||null
      };
    }
    return null;
  }).filter(e=>e!==null);
}

// Get full data in FHIR-like JSON
function getFHIR(){
  return {
    resourceType:"MTTPlan",
    patient:{
      id: pid.value,
      name: name.value,
      dob: dob.value,
      station: station.value,
      arzt: arzt.value,
      therapeut: therapeut.value,
      datum: datum.value
    },
    therapyPlan:{
      diagnose: diagnose.value,
      phase: phase.value,
      icf: icf.value,
      schmerz: schmerz.value
    },
    exercises: getExercises()
  };
}

// Export JSON
function exportJSON(){
  const data = getFHIR();
  const blob = new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="mtt_plan.json"; a.click();
  URL.revokeObjectURL(url);
}

// Export CSV
function exportCSV(){
  const ex = getExercises();
  if(ex.length===0){alert("Keine √úbungen f√ºr CSV");return;}
  const headers=["Nr","Art","Ger√§t","Watt","kg","S√§tze","Wdh","UPM","Pause","Kommentar"];
  const csv = [headers.join(",")].concat(
    ex.map(e=>headers.map(h=>JSON.stringify(e[h.toLowerCase()]||"")).join(","))
  ).join("\n");
  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download="mtt_plan.csv"; a.click();
  URL.revokeObjectURL(url);
}

// Collect patient+plan data
function getData(){
  return {
    pid:pid.value,name:name.value,dob:dob.value,station:station.value,
    arzt:arzt.value,therapeut:therapeut.value,datum:datum.value,
    diagnose:diagnose.value,phase:phase.value,icf:icf.value,schmerz:schmerz.value
  };
}
</script>
</body>
</html>
